name: DockDesk Audit

on: [pull_request, push]

jobs:
  audit:
    runs-on: ubuntu-latest
    services:
      ollama:
        image: ollama/ollama:latest
        ports:
          - 11434:11434
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Wait for Ollama
        run: |
          for i in {1..30}; do
            curl -s http://localhost:11434/api/tags && break
            sleep 2
          done
      
      - name: Pull Model
        run: |
          curl -X POST http://localhost:11434/api/pull \
            -d '{"name": "qwen2.5-coder:3b"}'
          sleep 10
      
      - uses: dockdesk/auditor@v2
        with:
          model: 'qwen2.5-coder:3b'
          fail_on_risk: 'HIGH'
      
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: audit-report
          path: audit_report.md
